name: Build PRoot Termux Deb
on: 
  workflow_dispatch:

jobs:
  build_arm64:
    name: Build Termux AArch64 Deb
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/termux/package-builder:latest
      options: --user root
    steps:
      - uses: actions/checkout@v4

      - name: Build and Package
        run: |
          # 1. 克隆官方构建工具
          cd /opt
          git clone --depth 1 https://github.com/termux/termux-packages.git
          TERMUX_BASE="/opt/termux-packages"
          
          # 2. 定位 NDK
          export NDK="/home/builder/lib/android-ndk-r29"
          echo "Using NDK: $NDK"

          # 3. 定义变量
          PKG_NAME="proot"
          # 这是 Termux 构建脚本默认的源码存放位置
          TERMUX_TOPDIR="/github/home/.termux-build"
          PKG_BUILDER_DIR="$TERMUX_TOPDIR/$PKG_NAME"
          PKG_SRC_DIR="$PKG_BUILDER_DIR/src"
          
          # 4. 准备目录并拷贝源码
          mkdir -p "$PKG_SRC_DIR"
          cp -r $GITHUB_WORKSPACE/* "$PKG_SRC_DIR/"

          # 5. 在构建目录执行源码修复
          cd "$PKG_SRC_DIR/src"
          mkdir -p linux
          curl -LSs -o linux/ashmem.h https://raw.githubusercontent.com/aosp-mirror/platform_bionic/master/libc/kernel/uapi/linux/ashmem.h
          sed -i '1i#include <linux/stat.h>' tracee/statx.h
          
          # 清理 ld 参数
          find . -name "GNUmakefile" -exec sed -i 's/-Wl,--rosegment//g' {} +
          find . -name "GNUmakefile" -exec sed -i 's/--rosegment//g' {} +
          find . -name "GNUmakefile" -exec sed -i 's/,,/,/g' {} +
          find . -name "GNUmakefile" -exec sed -i 's/-Wl, / /g' {} +

          # 6. 修改主仓库里的 build.sh 配置文件
          # 这里的路径必须绝对准确
          REAL_BUILD_SH="$TERMUX_BASE/packages/$PKG_NAME/build.sh"
          if [ -f "$REAL_BUILD_SH" ]; then
              # 清空下载地址，防止覆盖本地源码
              sed -i 's|^TERMUX_PKG_SRCURL=.*|TERMUX_PKG_SRCURL=|' "$REAL_BUILD_SH"
          else
              echo "Error: Cannot find $REAL_BUILD_SH"
              exit 1
          fi

          # 7. 运行构建
          # TERMUX_PKG_SKIP_SRC_EXTRACT 告诉脚本代码已经在 src 目录下了
          cd "$TERMUX_BASE"
          export TERMUX_PKG_SKIP_SRC_EXTRACT=true
          ./build-package.sh -a aarch64 -i "$PKG_NAME"

      - name: Upload Deb Artifact
        uses: actions/upload-artifact@v4
        with:
          name: proot-termux-aarch64-deb
          path: /opt/termux-packages/output/*.deb
